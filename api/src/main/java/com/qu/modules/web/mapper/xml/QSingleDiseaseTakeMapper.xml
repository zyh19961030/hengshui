<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qu.modules.web.mapper.QSingleDiseaseTakeMapper">
    <select id="singleDiseaseList" parameterType="java.lang.String" resultType="com.qu.modules.web.vo.QSingleDiseaseTakeVo">
        SELECT icd_name disease,count(1) count,icon  FROM `q_single_disease_take`
        <where>
            <if test="name !=null and name !=''">
                and icd_name like CONCAT('%',#{name},'%')
            </if>
        </where>
        group by icd_name  order by id
    </select>

    <sql id="reportStatisticCount">
        SELECT dynamic_table_name dynamicTableName,question_id questionId,
        <if test="deptShow !=null and deptShow==1 ">
            department dept,
        </if>
        count(1) inHospitalCount
        FROM `q_single_disease_take`
        <where>
            <if test="categoryId!=null and categoryId!=''">
                and category_id =#{categoryId}
            </if>
            <if test="dateType!=null">
                and in_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and in_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
            <if test="dept!=null and dept.length > 0">
                and department_id in
                <foreach close=")" collection="dept" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
        </where>
         group by icd_name
        <if test="deptShow !=null and deptShow==1 ">
            ,department
        </if>
    </sql>

    <select id="allSingleDiseaseReportStatisticCount" parameterType="java.lang.String" resultType="java.lang.Integer">
        select count(1) from (
        <include refid="reportStatisticCount"></include>
        ) t
    </select>


    <!--<select id="allSingleDiseaseReportStatistic" parameterType="java.lang.String" resultType="map">-->
    <select id="allSingleDiseaseReportStatistic" parameterType="java.lang.String" resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticVo">
    <include refid="reportStatisticCount"></include> limit #{startRow},#{pageSize}
    </select>

    <select id="countSql" parameterType="map" resultType="java.lang.Integer">
        SELECT count(1) FROM `q_single_disease_take`
        <where>
            <if test="categoryId!=null and categoryId!=''">
                and category_id =#{categoryId}
            </if>
            <if test="dept!=null and dept!=''">
                and department_id =#{dept}
            </if>
            <if test="status!=null">
                and status=#{status}
            </if>
            <if test="dateType!=null  and dateType!=''">
                and in_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and in_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
        </where>
    </select>


    <select id="countAvgSql" parameterType="map" resultType="map">
        /*round(AVG(drug_fee),2)*/
        select
            IFNULL(avg(in_hospital_day),0) avgInHospitalDay,
            IFNULL(AVG(in_hospital_fee),0) avgInHospitalFee,
            IFNULL(AVG(drug_fee),0) avgDrugFee,
            IFNULL(AVG(operation_treatment_fee),0) avgOperationTreatmentFee,
            IFNULL(AVG(disposable_consumable),0) avgDisposableConsumable
        FROM `q_single_disease_take`
        <where>
            <if test="categoryId!=null and categoryId!=''">
                and category_id =#{categoryId}
            </if>
            <if test="dept!=null and dept!=''">
                and department_id =#{dept}
            </if>
            <if test="dateType!=null  and dateType!=''">
                and in_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and in_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
        </where>
    </select>

    <select id="selectDept" parameterType="map" resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticDeptVo">
        select department_id departmentId,department from q_single_disease_take where department is not null and department is not null  group by department_id,department
    </select>

    <select id="allSingleDiseaseReportStatisticOverviewLine"
            parameterType="map"
            resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticOverviewLineVo">
        select
        <if test="dateType!=null and dateType=='yearly'">
            DATE_FORMAT(country_report_time,'%Y') date,
        </if>
        <if test="dateType!=null and dateType=='monthly'">
            DATE_FORMAT(country_report_time,'%Y-%m') date,
        </if>
        <if test="dateType!=null and dateType=='daily'">
            DATE_FORMAT(country_report_time,'%Y-%m-%d') date,
        </if>
        count(1) number from q_single_disease_take
        <where>
            <if test="categoryId!=null and categoryId.length > 0">
                and category_id in
                <foreach close=")" collection="categoryId" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
            <if test="status!=null">
                and status=#{status}
            </if>
            <if test="dateType!=null  and dateType!=''">
                and country_report_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and country_report_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
            <if test="dept!=null and dept.length > 0">
                and department_id in
                <foreach close=")" collection="dept" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
        </where>
        group by
        <if test="dateType!=null and dateType=='yearly'">
            DATE_FORMAT(country_report_time,'%Y')
        </if>
        <if test="dateType!=null and dateType=='monthly'">
            DATE_FORMAT(country_report_time,'%Y-%m')
        </if>
        <if test="dateType!=null and dateType=='daily'">
            DATE_FORMAT(country_report_time,'%Y-%m-%d')
        </if>
    </select>

    <select id="allSingleDiseaseReportStatisticOverviewPie" parameterType="map"
            resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticOverviewPieVo">
        select category_name disease,icd_name , count(1) number from q_single_disease_take q
        left join tqms_quota_category t  on q.category_id=t.category_id
        <where>
            <if test="categoryId!=null and categoryId.length > 0">
                and category_id in
                <foreach close=")" collection="categoryId" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
            <if test="status!=null">
                and status=#{status}
            </if>
            <if test="dateType!=null and dateType=='yearly'">
                and DATE_FORMAT(country_report_time,'%Y') =#{date}
            </if>
            <if test="dateType!=null and dateType=='monthly'">
                and DATE_FORMAT(country_report_time,'%Y-%m') =#{date}
            </if>
            <if test="dateType!=null and dateType=='daily'">
                and DATE_FORMAT(country_report_time,'%Y-%m-%d') =#{date}
            </if>
            <if test="dept!=null and dept.length > 0">
                and department_id in
                <foreach close=")" collection="dept" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
        </where>
        group by category_name
    </select>

    <select id="allSingleDiseaseReportStatisticTrend"
            parameterType="map"
            resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticTrendVo">
        select
        <if test="dateType!=null and dateType=='yearly'">
            DATE_FORMAT(country_report_time,'%Y') date,
        </if>
        <if test="dateType!=null and dateType=='monthly'">
            DATE_FORMAT(country_report_time,'%Y-%m') date,
        </if>
        <if test="dateType!=null and dateType=='daily'">
            DATE_FORMAT(country_report_time,'%Y-%m-%d') date,
        </if>
        count(1) number from q_single_disease_take
        <where>
            <if test="categoryId!=null and categoryId.length > 0">
                and category_id in
                <foreach close=")" collection="categoryId" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
            <if test="status!=null">
                and status=#{status}
            </if>
            <if test="dateType!=null  and dateType!=''">
                and country_report_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and country_report_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
            <if test="dept!=null and dept.length > 0">
                and department_id in
                <foreach close=")" collection="dept" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
        </where>
        group by
        <if test="dateType!=null and dateType=='yearly'">
            DATE_FORMAT(country_report_time,'%Y')
        </if>
        <if test="dateType!=null and dateType=='monthly'">
            DATE_FORMAT(country_report_time,'%Y-%m')
        </if>
        <if test="dateType!=null and dateType=='daily'">
            DATE_FORMAT(country_report_time,'%Y-%m-%d')
        </if>
    </select>


    <select id="allSingleDiseaseReportStatisticDeptPermutation"
            parameterType="map"
            resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticDeptPermutationVo">
        select department dept,
        count(1) number from q_single_disease_take
        <where>
            <if test="categoryId!=null and categoryId.length > 0">
                and category_id in
                <foreach close=")" collection="categoryId" item="listItem" open="(" separator=",">
                    #{listItem}
                </foreach>
            </if>
            <if test="status!=null">
                and status=#{status}
            </if>
            <if test="dateType!=null  and dateType!=''">
                and country_report_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and country_report_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
        </where>
        group by
        department
        order by number desc
    </select>

    <select id="allSingleDiseaseReportStatisticSummary"
            parameterType="map"
            resultType="com.qu.modules.web.vo.QSingleDiseaseTakeReportStatisticSummaryVo">
        select category_name disease,icd_name , count(1) number from q_single_disease_take q
        left join tqms_quota_category t  on q.category_id=t.category_id
        <where>
            <if test="status!=null">
                and status=#{status}
            </if>
            <if test="dateType!=null and dateType!=''">
                and country_report_time >=STR_TO_DATE(#{dateStart},'%Y-%m-%d %H:%i:%S')
                and country_report_time &lt;STR_TO_DATE(#{dateEnd},'%Y-%m-%d %H:%i:%S')
            </if>
            <if test="dept!=null and dept!=''">
                and department_id =#{dept}
            </if>
        </where>
        group by
        disease
        order by number desc
    </select>
</mapper>